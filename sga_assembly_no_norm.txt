#!/usr/bin/make -rRsf

###        -usage 'sga_assembly_no_norm.mk RUN=run CPU=8 MEM=15 READ1=/home/lauren/Documents/testes.R1.fastq.gz

READ2=/home/lauren/Documents/testes.R2.fastq.gz'
###        -RUN= name of run

MEM=5
CPU=5
RUN=run
READ1=/home/lauren/Documents/testes.R1.fastq.gz
READ2=/home/lauren/Documents/testes.R2.fastq.gz

SHELL=/bin/bash -o pipefail
# SGA version
SGA=sga-0.10.12
DWGSIM=dwgsim
REPORT=sga-preqc-report.py


#change the data
#This re-names my samples:
samp1 := p_eremicus


#Below after the all command are the final output files from SGA and normalization and trinity:
#Must be added in order of completion!!!
all:$(CURDIR)/p_eremicus/p_eremicus_preprocessed.fastq.gz

#$(CURDIR)/p_eremicus/p_eremicus_sga.fastq.gz $(CURDIR)/p_eremicus/p_eremicus_sga_no_norm_trinity.fasta


#################################SGA####################################

# Pre-process the dataset: recall that NEED gz file form for this step
$(CURDIR)/p_eremicus/p_eremicus_preprocessed.fastq.gz:/home/lauren/Documents/testes.R1.fastq.gz /home/lauren/Documents/testes.R2.fastq.gz
        sga preprocess --pe-mode 1 /home/lauren/Documents/testes.R1.fastq.gz /home/lauren/Documents/testes.R2.fastq.gz > $@


#####################Edited to this point##########################



		
            
# Build the FM-index 
%.bwt: %.fastq.gz
		$(SGA) index -a ropebwt -t 8 --no-reverse $<

		
# Make the preqc file for the short read set
%.preqc: %.bwt %.fastq.gz
		$(SGA) preqc -t 8 $(patsubst %.bwt, %.fastq.gz, $<) > $@

		
# Final PDF report
main_report.pdf: samp1.preqc  
		python $(REPORT) $+
		mv preqc_report.pdf $@

# SGA correction				
$(CURDIR)/$(samp1)/(samp1).sga.fastq:\ 
$(CURDIR)/$(samp1)/p_eremicus_preprocessed.fastq.gz   
	sga correct -k 41 --discard --learn -t 8 -o (samp1).sga.fastq p_eremicus_preprocessed.fastq.gz


#######################Trimmomatic/Trinity##########################

$(CURDIR)/$(samp1)/(samp1).sga_no_norm_trinity.fasta:\ 
$(CURDIR)/$(samp1)/$(samp1).sga.fastq.gz #input from sga
	Trinity --seqType fq --JM 50G --trimmomatic \
    --left $<  \
    --right $(word 2,$^) \
    --CPU $(CPU) --output $(samp1).sga_no_norm_trinity.fasta \
    --quality_trimming_params "ILLUMINACLIP:$(CURDIR)/barcodes.fa:2:40:15 LEADING:2 TRAILING:2 MINLEN:25"